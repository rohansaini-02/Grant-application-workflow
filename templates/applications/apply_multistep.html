{% extends 'base.html' %}

{% block title %}Create Application - Step {{ step }} of 5{% endblock %}

{% block extra_css %}
<style>
    .application-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem;
    }

    .application-header {
        background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
        color: white;
        padding: 2rem 2.5rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
    }

    .application-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 50%;
        height: 100%;
        background: radial-gradient(circle at 70% 50%, rgba(255, 255, 255, 0.15) 0%, transparent 60%);
        pointer-events: none;
    }

    .application-header h1 {
        font-size: 1.75rem;
        font-weight: 800;
        margin: 0;
        position: relative;
        z-index: 1;
    }

    /* Stepper */
    .stepper {
        display: flex;
        justify-content: space-between;
        padding: 1.5rem 2rem;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 16px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        position: relative;
    }

    .step {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 2;
    }

    .step-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin: 0 auto 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.1rem;
        transition: all 0.4s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .step-circle.active {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(16, 185, 129, 0.4);
    }

    .step-circle.completed {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .step-circle.inactive {
        background: #e2e8f0;
        color: #94a3b8;
    }

    .step-label {
        font-size: 0.85rem;
        font-weight: 600;
        transition: color 0.3s ease;
    }

    .step-label.active {
        color: #10b981;
    }

    .step-label.inactive {
        color: #94a3b8;
    }

    .step-connector {
        position: absolute;
        top: 25px;
        height: 3px;
        background: #e2e8f0;
        z-index: 1;
        transition: background 0.4s ease;
    }

    .step-connector.completed {
        background: linear-gradient(90deg, #10b981 0%, #059669 100%);
    }

    /* Form Cards */
    .form-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(16, 185, 129, 0.1);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .form-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #10b981 0%, #059669 50%, #047857 100%);
    }

    .form-card:hover {
        box-shadow: 0 8px 35px rgba(16, 185, 129, 0.15);
        transform: translateY(-2px);
    }

    .form-card h2 {
        font-size: 1.4rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 1.5rem 0;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e2e8f0;
    }

    /* Form Controls */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.5rem;
        display: block;
        font-size: 0.95rem;
    }

    .form-control {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #f8fafc;
    }

    .form-control:focus {
        outline: none;
        border-color: #10b981;
        background: white;
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }

    .form-control::placeholder {
        color: #94a3b8;
    }

    textarea.form-control {
        resize: vertical;
        min-height: 120px;
    }

    input[type="file"].form-control {
        padding: 0.75rem;
        cursor: pointer;
    }

    input[type="file"].form-control::file-selector-button {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        margin-right: 1rem;
        transition: all 0.3s ease;
    }

    input[type="file"].form-control::file-selector-button:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .form-hint {
        font-size: 0.85rem;
        color: #64748b;
        margin-top: 0.5rem;
    }

    /* Review Section */
    .review-section {
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .review-section h3 {
        font-size: 1.1rem;
        font-weight: 700;
        color: #047857;
        margin: 0 0 1rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .review-section p {
        margin: 0.5rem 0;
        color: #334155;
    }

    .review-section strong {
        color: #1e293b;
    }

    /* Confirmation Box */
    .confirmation-box {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        padding: 1.25rem;
        border-radius: 12px;
        border-left: 4px solid #3b82f6;
        margin-top: 1.5rem;
    }

    .confirmation-box label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        font-weight: 500;
        color: #1e40af;
    }

    .confirmation-box input[type="checkbox"] {
        width: 20px;
        height: 20px;
        accent-color: #3b82f6;
    }

    .note-box {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        padding: 1.25rem;
        border-radius: 12px;
        border-left: 4px solid #f59e0b;
        margin-top: 1rem;
        color: #92400e;
    }

    /* Navigation Buttons */
    .nav-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .btn-nav {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.875rem 1.5rem;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .btn-prev {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        color: #475569;
    }

    .btn-prev:hover {
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        transform: translateX(-3px);
    }

    .btn-next {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-next:hover {
        transform: translateX(3px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }

    .btn-draft {
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        color: white;
    }

    .btn-draft:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(71, 85, 105, 0.3);
    }

    .btn-submit {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    }

    .btn-group {
        display: flex;
        gap: 0.75rem;
    }

    @media (max-width: 768px) {
        .stepper {
            flex-wrap: wrap;
            gap: 1rem;
        }

        .step-connector {
            display: none;
        }

        .nav-buttons {
            flex-direction: column;
            gap: 1rem;
        }

        .btn-group {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="application-container">
    <!-- Header -->
    <div class="application-header">
        <h1>üìù New Application{% if call %} - {{ call.title }}{% endif %}</h1>
    </div>

    <!-- Stepper -->
    <div class="stepper">
        {% for i in "12345" %}
        <div class="step">
            <div
                class="step-circle {% if forloop.counter < step %}completed{% elif forloop.counter == step %}active{% else %}inactive{% endif %}">
                {% if forloop.counter < step %}‚úì{% else %}{{ forloop.counter }}{% endif %} </div>
                    <div class="step-label {% if forloop.counter == step %}active{% else %}inactive{% endif %}">
                        {% if forloop.counter == 1 %}Basic Info
                        {% elif forloop.counter == 2 %}Team
                        {% elif forloop.counter == 3 %}Proposal
                        {% elif forloop.counter == 4 %}Documents
                        {% else %}Review{% endif %}
                    </div>
            </div>
            {% endfor %}
        </div>

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            {% if step == 1 %}
            <!-- Step 1: Basic Info -->
            <div class="form-card">
                <h2>üìã Basic Information</h2>

                <div class="form-group">
                    <label class="form-label" for="title">Application Title *</label>
                    <input type="text" id="title" name="title" class="form-control" value="{{ form_data.title }}"
                        required maxlength="500" placeholder="Enter a descriptive title for your application">
                </div>

                <div class="form-group">
                    <label class="form-label" for="abstract">Abstract *</label>
                    <textarea id="abstract" name="abstract" class="form-control" rows="6" required maxlength="1000"
                        placeholder="Provide a brief summary of your proposal (max 300 words)">{{ form_data.abstract }}</textarea>
                    <span class="form-hint">üìù Provide a brief summary of your proposal (max 300 words)</span>
                </div>

                <div class="form-group">
                    <label class="form-label" for="tags">Keywords/Tags</label>
                    <input type="text" id="tags" name="tags" class="form-control" value="{{ form_data.tags }}"
                        placeholder="biology, climate, research">
                    <span class="form-hint">üè∑Ô∏è Comma-separated keywords for categorization</span>
                </div>

                <div class="form-group">
                    <label class="form-label" for="requested_amount">Requested Funding Amount *</label>
                    <input type="number" id="requested_amount" name="requested_amount" class="form-control"
                        value="{{ form_data.requested_amount }}" required min="0" step="0.01" placeholder="50000">
                    <span class="form-hint">üí∞ Enter the amount in dollars</span>
                </div>
            </div>

            {% elif step == 2 %}
            <!-- Step 2: Team Info -->
            <div class="form-card">
                <h2>üë• Team Information</h2>

                <div class="form-group">
                    <label class="form-label">Principal Investigator</label>
                    <input type="text" class="form-control" value="{{ user.get_full_name }}" readonly
                        style="background: #e2e8f0;">
                    <span class="form-hint">üë§ Your information (prefilled)</span>
                </div>

                <div class="form-group">
                    <label class="form-label" for="co_investigators">Co-Investigators</label>
                    <textarea id="co_investigators" name="co_investigators" class="form-control" rows="4"
                        placeholder="Name, Institution&#10;Name, Institution">{{ form_data.co_investigators }}</textarea>
                    <span class="form-hint">üë• List co-investigators, one per line</span>
                </div>

                <div class="form-group">
                    <label class="form-label" for="affiliations">Institutional Affiliations</label>
                    <textarea id="affiliations" name="affiliations" class="form-control" rows="3"
                        placeholder="List your institutional affiliations">{{ form_data.affiliations }}</textarea>
                </div>
            </div>

            {% elif step == 3 %}
            <!-- Step 3: Detailed Proposal -->
            <div class="form-card">
                <h2>üìÑ Detailed Proposal</h2>

                <div class="form-group">
                    <label class="form-label" for="full_proposal">Full Proposal Text</label>
                    <textarea id="full_proposal" name="full_proposal" class="form-control" rows="15"
                        placeholder="Enter your detailed proposal here...">{{ form_data.full_proposal }}</textarea>
                    <span class="form-hint">üìé Or upload a PDF document in the next step</span>
                </div>

                <div class="form-group">
                    <label class="form-label" for="budget_summary">Budget Summary</label>
                    <textarea id="budget_summary" name="budget_summary" class="form-control" rows="6"
                        placeholder="Item | Amount&#10;Personnel | $50,000&#10;Equipment | $20,000">{{ form_data.budget_summary }}</textarea>
                    <span class="form-hint">üíµ Break down your budget by category</span>
                </div>
            </div>

            {% elif step == 4 %}
            <!-- Step 4: Documents -->
            <div class="form-card">
                <h2>üìÅ Supporting Documents</h2>

                <div class="form-group">
                    <label class="form-label" for="proposal_doc">Proposal Document (PDF)</label>
                    <input type="file" id="proposal_doc" name="proposal_doc" class="form-control" accept=".pdf">
                    <span class="form-hint">üìÑ Upload your full proposal as PDF</span>
                </div>

                <div class="form-group">
                    <label class="form-label" for="budget_doc">Budget Document</label>
                    <input type="file" id="budget_doc" name="budget_doc" class="form-control" accept=".pdf,.xlsx,.xls">
                    <span class="form-hint">üìä PDF or Excel format accepted</span>
                </div>

                <div class="form-group">
                    <label class="form-label" for="cv_doc">CV/Resume</label>
                    <input type="file" id="cv_doc" name="cv_doc" class="form-control" accept=".pdf">
                    <span class="form-hint">üìã Your current CV in PDF format</span>
                </div>

                <div class="form-group">
                    <label class="form-label" for="other_docs">Other Supporting Documents</label>
                    <input type="file" id="other_docs" name="other_docs" class="form-control" multiple>
                    <span class="form-hint">üìé Letters of support, ethics approvals, etc.</span>
                </div>
            </div>

            {% else %}
            <!-- Step 5: Review & Submit -->
            <div class="form-card">
                <h2>‚úÖ Review Your Application</h2>

                <div class="review-section">
                    <h3>üìã Basic Information</h3>
                    <p><strong>Title:</strong> {{ form_data.title }}</p>
                    <p><strong>Abstract:</strong> {{ form_data.abstract|truncatewords:50 }}</p>
                    <p><strong>Requested Amount:</strong> ${{ form_data.requested_amount }}</p>
                    <p><strong>Tags:</strong> {{ form_data.tags }}</p>
                </div>

                <div class="review-section">
                    <h3>üë• Team</h3>
                    <p><strong>PI:</strong> {{ user.get_full_name }}</p>
                    {% if form_data.co_investigators %}
                    <p><strong>Co-Investigators:</strong><br>{{ form_data.co_investigators|linebreaks }}</p>
                    {% endif %}
                </div>

                <div class="confirmation-box">
                    <label>
                        <input type="checkbox" name="confirm_accuracy" required>
                        <span>I confirm that all information provided is accurate and complete</span>
                    </label>
                </div>

                <div class="note-box">
                    <strong>‚ö†Ô∏è Note:</strong> This submission will be blinded for reviewers. Your name and institutional
                    affiliation will be hidden during the review process.
                </div>
            </div>
            {% endif %}

            <!-- Navigation Buttons -->
            <div class="nav-buttons">
                <div>
                    {% if step > 1 %}
                    <button type="submit" name="action" value="previous" class="btn-nav btn-prev">‚Üê Previous</button>
                    {% else %}
                    <a href="{% url 'applications:list' %}" class="btn-nav btn-prev">‚úï Cancel</a>
                    {% endif %}
                </div>
                <div class="btn-group">
                    <button type="submit" name="action" value="save_draft" class="btn-nav btn-draft">üíæ Save
                        Draft</button>
                    {% if step < 5 %} <button type="submit" name="action" value="next" class="btn-nav btn-next">Next
                        ‚Üí</button>
                        {% else %}
                        <button type="submit" name="action" value="submit" class="btn-nav btn-submit">üöÄ Submit
                            Application</button>
                        {% endif %}
                </div>
            </div>
        </form>
    </div>
    {% endblock %}